<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motchill</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6115578805916449"
     crossorigin="anonymous"></script>
     <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  </head>
<body>
  <header>
    <section class="header">
       
            <div class="header-container">
                <div class="header-top">
                    <div class="container">
                        <div class="header-top-container ">
                          <div class="header-logo">
                           <a href="/"> <img srcset="./assets/motchill.png 2x" alt=""></a>
                          </div>
                          <div class="form__group field">
                            <input type="input" class="search-input" placeholder="Tìm kiếm" name="search" id='name' required />
                            <label for="name" class="form__label">Nhập tên phim cần tìm</label>
                          </div>
                          <!-- <input type="text" placeholder="Search" class="search-input"> -->
                        
                          <div class="header-acount">
                            <i class="fas fa-bars"></i>
                          
                          </div>    
                              <div class="header-right">
                                 
                                  <div class="header-auth">
                                    <div class="header-login">
                                       <a href="login/index.html" class="login" class="btnLogin">
                                         Đăng nhập
                                       </a>
                                    </div>        
                                    <div class="header-register">
                                        <a href="sigup/index.html" class="register" class="btnRegister">
                                          Đăng ký 
                                        </a>
                                  </div>
                                  
                                  
                                </div>
                                <div class="header-auth-work" style="display:none !important">
                                  <div class="header-bookmark">
                                    <i class="fa-solid fa-bookmark"></i>
                                    Bookmark
                                  </div>
                                  <div class="header-account">
                                    <div class="header-account-name">
                                      <img srcset='../assets/avt.png 2x'style="width:50px ; height:50px"></img>
                                      </div>
                                  </div>
                                  
                                  <div class="dropdown">
                                   
                                      <i class="fa-solid fa-angle-down dropbtn"></i>
                          
                                    <div id="myDropdown" class="dropdown-content">
                                      <div class="account-name">

                                      </div>
                                      <div> Tài khoản</div>
                                      <div> Cài đặt</div>
                                      <div> Trợ giúp</div>
                                      <div class="header-logout" onclick="signOut()">
                                        Đăng xuất
                                        
                                       </div>
                                       
                                    </div>
                                  </div>
                                 
                                </div>
                              </div>
                          </div>
                        </div>
                    </div>
                </div>
                <script src="./js/navbar.js"></script>
                <div class="header-nav">
                    <div class="container">
                        <div class="header-nav-container">
                            <ul class="header-nav-list">
                                <li class="header-nav-item">
                                  <a href="/">
                                    <span class="header-nav-homepage" > TRANG CHỦ</span>
                                  </a>
                                </li>
                                <li class="header-nav-item--genres">
                                    <div class="header-nav-title">
                                        THỂ LOẠI
                                    </div> 
                                    <ul class="header-nav-genres">
                                        <li class="header-nav-genres--phimle">
                                            <ul class="header-nav-genres--movie_list">
                                              <span> Phim lẻ</span>
                                            </ul>
                                        </li>
                                        <li class="header-nav-genres--phimbo">
                                          <ul class="header-nav-genres--tv_list">
                                           <span>Phim bộ</span>
                                        </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="header-nav-item--country">
                                  <div class="header-nav-title">
                                        QUỐC GIA
                                  </div> 
                                  <ul class="header-nav-country">
                                      
                                  </ul>
                              </li>
                               <li class="header-nav-item--movie">
                                <div class="header-nav-title">
                                  <a href="kho-phim.html?category=tv">
                                    <span class="header-nav-tv" > PHIM BỘ</span>
                                  </a>
                                </div> 
                                
                              </li>
                              <li class="header-nav-item--tv">
                                <div class="header-nav-title">
                                  <a href="kho-phim.html?category=movie">
                                    <span class="header-nav-movie" > PHIM LẺ</span>
                                  </a>
                                </div> 
                                <ul class="header-nav-tv-show">
                                    
                                </ul>
                              </li>
                              <li class="header-nav-item--date">
                                <div class="header-nav-title">
                                     NĂM SẢN XUẤT
                                </div> 
                                <ul class="header-nav-date">
                                    
                                </ul>
                              </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</header>
    <main>
        <section class="watch">
            <div class="container">
                <div class="watch-container">
                 
                    <div class="watch-iframe">

                    </div>
                    <div class="watch-infor">
                      
                    </div>
                    <div class="watch-tv-other">

                    </div>
                </div>
            </div>
        </section>
        <section class="watch-main">
            <div class="container">
              <div class="watch-main-container">
                  <section class="comments">
                    <div class="container">
                      <div class="comment-container">
        
                          <div class="comment-title">
                            Bình luận
                          </div>
                          <div class="comment-main">

                            <ul class="component-unordered" style="padding-right: 2rem;" >
                             
                           </ul>
                            <div class="comment-form"> 
                              <textarea type="text" class="comment-box" placeholder="Nhập bình luận"></textarea>
                              <!-- <button class="comment-post button" onclick="insertComment();window.scroll(300,200);">Bình luận</button> -->
                              <button class="comment-post button" >Bình luận</button>
                            </div> 
                          </div>
                      </div>
                    </div>
                  </section>
              
                  <!-- <section class="watch-main-genres">
                      <div class="container">
                        <div class="watch-main-genres-container">
                            <div class="watch-main-genres-title">
                               Phim tương tự 
                            </div>           
                            <ul class="watch-main-genres-list">

                            </ul>             
                          </div>
                      </div>
                  </section> -->
              </div>
            </div>
        </section>
        <section class="watchs-genres">
         
            <div class="watchs-genres-container">
                <div class="watchs-genres-title">
                   Phim tương tự 
                </div>           
                <ul class="watchs-genres-list">
                    
                </ul>             

          </div>
      </section>
    </main>
    <footer class="footer">
        <div class="container">
          <div class="footer-container">
             
              <div class="footer-content"> 
                <div class="footer-logo">
                <img srcset="./assets/motchill.png 2x" alt="">
                <div class="author">
                  Nhóm thực hiện:
                     <div> Thái - Tân - Cường - Giang</div>
                     <div> Thực tập tại 3S - Huế</div>
                   </div>
                </div>

                  <div class="phim-moi">
                    <div class="phim-moi-title">
                      Phim mới
                    </div>
                    <ul class="phim-moi-list">
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-moi-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                    </ul>
                  </div>
                  <div class="phim-hay">
                    <div class="phim-hay-title">
                      Phim hay
                    </div>
                    <ul class="phim-hay-list">
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hay-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                    </ul>
                  </div>
                  <div class="phim-hot">
                    <div class="phim-hot-title">
                      Phim hot
                    </div>
                    <ul class="phim-hot-list">
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                      <li class="phim-hot-item">
                        <a href="">Phim chiếu rạp</a>
                      </li>
                    </ul>
                  </div>
                  <div class="help">
                    <div class="help-title">
                      Trợ giúp
                    </div>
                    <ul class="help-list">
                      <li class="phim-hot-item">
                        <a href="">Hỏi đáp</a>
                      </li>
                      <li class="help-item">
                        <a href="">Liên hệ</a>
                      </li>
                      <li class="help-item">
                        <a href="">Tin tức</a>
                      </li>
                      
                    </ul>
                  </div>
                  <div class="infor">
                    <div class="infor-title">
                      Thông tin
                    </div>
                    <ul class="infor-list">
                      <li class="infor-item">
                        <a href="">Điều khoản sử dụng</a>
                      </li>
                      <li class="infor-item">
                        <a href="">Chính sách riêng tư</a>
                      </li>
                      <li class="infor-item">
                        <a href="">Khiếu nại bản quyền</a>
                      </li>
                     
                      <li class="infor-item">
                          @2022 MotChill.Net 
                      </li>
                    </ul>
                  </div>
              </div>
          </div>
        </div>
    </footer>
</body>
</html>
<script src="./js/homepage.js" type="module"></script>
<script src="./js/watch.js"></script>
<script src="./js/comment.js"></script>



<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    // variable
    const supabaseUrl = 'https://eewlfvfpotbjkllqvkka.supabase.co'
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVld2xmdmZwb3RiamtsbHF2a2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NTk3OTY3MjMsImV4cCI6MTk3NTM3MjcyM30.sLO8m0_QuY1rvD9gEXFwdMHM1vV-0utUI4m9IdBkW4c"
    const { createClient } = supabase
    const _supabase = createClient(`${supabaseUrl}`,`${supabaseKey}`)
    const inputValue = document.querySelector(".comment-box") ;
 
    const user = _supabase.auth.user() ; 
    const id = new URL(window.location.href).searchParams.get("id");
    const category = new URL(window.location.href).searchParams.get("category");
    const season = new URL(window.location.href).searchParams.get("season");
    const epi = new URL(window.location.href).searchParams.get("epi");
    const btnComment = document.querySelector(".comment-post") ; 
    const token = JSON.parse(localStorage.getItem("supabase.auth.token"));
    if ( !token) {
      Toastify({
       text: "Vui lòng đăng nhập trước khi xem phim!",
       className: "info",
       style: {
       background: "linear-gradient(to right, #00b09b, #96c93d)",
       duration: 10000
   }}).showToast();
    setTimeout(() => {
      window.location.href= "login/index.html";
    }, 1000);
   }
   else {
    btnComment.addEventListener("on", () => {
      !inputValue.value ? btnComment.classList.add("disable") : btnComment.classList.remove("disable")
    })
    const getlistComments = async () => {


      const config =  {
                method : 'GET', 
                headers : {
                    'Accept': 'application/json',
                     'Content-Type': 'application/json',    
                     'apikey' : supabaseKey ,
                     'Authorization' : `Bearer ${supabaseKey}`
                }      
        }
          try {
            const listComment = document.querySelector(".component-unordered") ;
        
              const response = await fetch( `${supabaseUrl}/rest/v1/comments?category=eq.${category}&film_id=eq.${id}&select=*${category=="movie"?"":`&season=eq.${season}&epi=eq.${epi}`}`, config)
            // Hàm đang sai
            const formatTime = (time) => {
              const now = new Date().getTime() ;
              console.log(now)
              return Math.round((now-time.getTime())/3600);
            }
            const data = await response.json() ; 
            const comments = data ;
            comments.sort((a, b) => new Date(b.date) - new Date(a.date)).reverse()
            comments.map((item,index)=> {
              console.log(item)
            let childComment = document.createElement("li") ; 
              childComment.setAttribute("class","comment-child");
              childComment.innerHTML = `
              <div class="comment-image">
                  <img src="./assets/avt2.jpg" alt="avt"/>
              </div>
              <div class="comment-infor">
                    <div class="comment-username">
                      ${item.username} 
                    </div>
                    <div class="comment-date">
                      ${new Date(item.created_at).toLocaleDateString("vi-VN")} - ${formatTime(new Date(item.created_at))}
                    </div>
                    <div class="comment-text">
                    ${item.payload}  
                </div>
                </div>
               
              `
              listComment.appendChild(childComment)
           }) 
          } catch (error) {
            
          }
  }
    const insertComment = async() => {
    
      const config =  {
                method : 'POST', 
                headers : {
                    'Accept': 'application/json',
                     'Content-Type': 'application/json',    
                     'apikey' : supabaseKey ,
                     'Authorization' : `Bearer ${supabaseKey}`
                },
                body: JSON.stringify( 
                  category =="movie"? {
                    category : category ,
                    film_id: id,
                    username: user.user_metadata.fullname?  user.user_metadata.fullname : user.email,
                    payload: inputValue.value 
                  }: 
                  {
                    category : category ,
                    film_id: id,
                    season: season, 
                    username: user.user_metadata?  user.user_metadata : user.email,
                    payload: inputValue.value ,
                    epi : epi
                  }
                 
                )
            }
          try {
          
            const response = await fetch(`${supabaseUrl}/rest/v1/comments`, config)
            console(response)
            const data = await response.json() ;  
         
          } catch (error) {
            
          }
        
          window.location.href = window.location.href;
       
         
    }   
    getlistComments();
    document.querySelector(".comment-post").addEventListener("click", () => {
      insertComment() ;
     setTimeout(() => {
      window.scroll(300,200);
     },1000)
   })
   
   }


  
    


</script>

